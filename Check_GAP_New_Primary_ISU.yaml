---
- name: MFGI_UAT_DB_IDFGISU_CHECK_GAP_REP_DEV
  hosts: db_dev_servers
  gather_facts: no
  tasks:
    - name: Load environment Oracle
      shell: ". .IDFGISU1"
      args:
        executable: /bin/bash

    - name: Jalankan query perbandingan log archive dan log history
      shell: |
        sqlplus -s / as sysdba <<EOF
        SET LINESIZE 200
        SET PAGESIZE 100
        SET FEEDBACK OFF
        SET HEADING ON
        SELECT ARCH.THREAD# "Thread",
               ARCH.SEQUENCE# "Last Sequence Received",
               APPL.SEQUENCE# "Last Sequence Applied",
               (ARCH.SEQUENCE# - APPL.SEQUENCE#) "Difference"
        FROM
          (SELECT THREAD# ,SEQUENCE#
           FROM V$ARCHIVED_LOG
           WHERE (THREAD#,FIRST_TIME ) IN
             (SELECT THREAD#,MAX(FIRST_TIME)
              FROM V$ARCHIVED_LOG
              GROUP BY THREAD#)) ARCH,
          (SELECT THREAD# ,SEQUENCE#
           FROM V$LOG_HISTORY
           WHERE (THREAD#,FIRST_TIME ) IN
             (SELECT THREAD#,MAX(FIRST_TIME)
              FROM V$LOG_HISTORY
              GROUP BY THREAD#)) APPL
        WHERE ARCH.THREAD# = APPL.THREAD#;
        exit;
        EOF
      args:
        executable: /bin/bash
      register: log_comparison_result

    - name: Tampilkan hasil query perbandingan log
      debug:
        var: log_comparison_result.stdout